<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Article</title>

  <!-- SEO (single, stable block) -->
  <meta name="description" content="Comparison picks and recommendations." />
  <link rel="canonical" href="" />

  <meta property="og:type" content="article" />
  <meta property="og:title" content="Article" />
  <meta property="og:description" content="Comparison picks and recommendations." />
  <meta property="og:url" content="" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Article" />
  <meta name="twitter:description" content="Comparison picks and recommendations." />

  
  <link rel="stylesheet" href="assets/site.css">
</head>
<body>
  <header>
    <div class="wrap topbar">
      <div>
        <a class="brand" href="./index.html">Simple Product Picks (UK)</a>
        <div class="meta" id="meta">Loading…</div>
      </div>
      <nav class="site-nav">
  <a href="./index.html">Home</a>
  <a href="./posts.html">All posts</a>
</nav>

    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <h1 id="pageTitle">Loading…...</h1>
      <p id="pageDesc">We’re loading the article content. If this takes more than a few seconds, refresh the page.</p>
    </section>

    <div class="grid2">
      <article class="card pad">
        <div class="content" id="content">Loading…...</div>
      </article>

      <aside class="card pad" aria-label="Quick actions">
        <div class="verdict" id="verdictBox" style="display:none">
          <h2 id="verdictTitle">Quick verdict</h2>
          <p id="verdictText"></p>
        </div>

        <div style="height:12px"></div>

        <div class="ctaRow" aria-label="Actions">
          <a id="ctaPrimary" class="btn primary disabled" href="#" rel="nofollow noopener" aria-disabled="true">Check price (coming soon)</a>
          <a id="ctaSecondary" class="btn disabled" href="#" rel="nofollow noopener" aria-disabled="true">See alternatives</a>
        </div>
        <div class="note">Affiliate links will be enabled once product URLs are wired in (PA-API / SiteStripe).</div>

        <div style="height:18px"></div>

        <div id="relatedWrap" style="display:none">
          <div style="font-weight:750;margin:0 0 8px">Related articles</div>
          <div class="relatedGrid" id="relatedGrid"></div>
        </div>
      </aside>
    </div>
  </main>

  <footer>
    <div class="wrap">
      <div>© <span id="year"></span> Simple Product Picks (UK). Some links may become affiliate links later; this site may earn a commission at no extra cost to you.</div>
    </div>
  </footer>

  <script src="./assets/purify.min.js"></script>
  <script src="./assets/marked.min.js"></script>
  <script>
  // ---- Single source of truth: base + SEO helpers (defined once) ----
  const __BASE = (location.origin + location.pathname.replace(/\/[^/]*$/, "/")).replace(/\/posts_html\/$/, "/");
  const __CANON_BASE = location.origin + location.pathname.replace(/\/posts_html\/.+$/, "/");

  function __escapeHtml(s){
    return String(s || "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  function __setCanonical(url){
    const link = document.querySelector('link+rel="canonical"]');
    if(link) link.setAttribute("href", url);
    const ogu = document.querySelector('meta[property="og:url"]');
    if(ogu) ogu.setAttribute("content", url);
  }

  function __setMeta(name, content){
    const m = document.querySelector('meta[name="' + name + '"]');
    if(m) m.setAttribute("content", content);
  }
  function __setOg(prop, content){
    const m = document.querySelector('meta[property="' + prop + '"]');
    if(m) m.setAttribute("content", content);
  }

  function __deriveDesc(h1Text){
    const t = (h1Text || "Comparison picks and recommendations").trim();
    return t.length > 155 ? (t.slice(0,152) + "...") : t;
  }

  async function __loadRelated(slug){
    try{
      const r = await fetch("./assets/posts_index.json", {cache:"no-store"});
      if(!r.ok) return;
      const idx = await r.json();
      if(!idx || !idx9by_slug || !idx.by_slug[slug]) return;
      const rel = idx.by_slug[slug].related || [];
      if(!Array.isArray(rel) || rel.length === 0) return;

      const grid = document.getElementById("relatedGrid");
      grid.innerHTML = "";
      for(const rs of rel.slice(0,6)){
        const item = idx.by_slug[rs];
        if(!item) continue;
        const a = document.createElement("a");
        a.className = "relatedItem";
        a.href = "./posts_html/" + encodeURIComponent(rs) + ".html";
        a.innerHTML = '<div class="t">' + __escapeHtml(item.title||rs) + '</div><p class="d">' + __escapeHtml(item.desc||"") + '</p>';
        grid.appendChild(a);
      }
      document.getElementById("relatedWrap").style.display = grid.children.length ? "" : "none";
    }catch(_e){}
  }

  function __applySeo(slug, h1Text){
    const title = (h1Text && h1Text.trim()) ? h1Text.trim() : "Article";
    document.title = title;
    document.getElementById("pageTitle").textContent = title;

    const desc = __deriveDesc(title);
    document.getElementById("pageDesc").textContent = desc;

    __setMeta("description", desc);
    __setOg("og:title", title);
    __setOg("og:description", desc);
    __setMeta("twitter:title", title);
    __setMeta("twitter:description", desc);

    const isPostsHtml = location.pathname.includes("/posts_html/");
    if(isPostsHtml){
      __setCanonical(location.origin + location.pathname.replace(/\?.*$/, ""));
    }
  }

  function __tryExtractVerdict(container){
    const h2s = container.querySelectorAll("h2");
    for(const h2 of h2s){
      const t = (h2.textContent||"").trim().toLowerCase();
      if(t.includes("quick verdict") || t === "verdict" || t.includes("verdict:")){
        const p = h2.nextElementSibling;
        if(p && p.tagName && p.tagName.toLowerCase() === "p" && (p.textContent||"").trim().length){
          return { title: h2.textContent.trim(), text: (p.textContent||"").trim() };
        }
      }
    }
    return null;
  }

  // ---- Main ----
  (async () => {
    document.getElementById("year").textContent = String(new Date().getFullYear());

    // Determine slug + mdPath
    let slug = null;
    let mdPath = null;

    const m = location.pathname.match(/\/posts_html\/([^/]+)\.html$/);
    if(m){ slug = decodeURIComponent(m[1]); mdPath = "./posts/" + slug + ".md"; }

    const usp = new URLSearchParams(location.search);
    if(!slug && usp.get("slug")){ slug = usp.get("slug"); mdPath = "./posts/" + slug + ".md"; }

    if(!slug){
      document.getElementById("meta").textContent = "missing slug";
      document.getElementById("content").textContent = "Missing slug. Open from the index page.";
      return;
    }

    document.getElementById("meta").textContent = slug;

    let md = "";
    try{
      const r= await fetch(mdPath, {cache:"no-store"});
      if(!r.ok) throw new Error("fetch failed");
      md = await r.text();
    }catch(_e){
      document.getElementById("content").textContent = "Could not load article source (" + mdPath + ").";
      return;
    }

    const html = marked.parse(md, { mangle:false, headerIds:true });
    const safe = DOMPurify.sanitize(html, {USE_PROFILES:{html:true}});
    const contentEl = document.getElementById("content");
    contentEl.innerHTML = safe;

    const h1 = contentEl.querySelector("h1");
    const h1Text = h1 && h1.textContent ? h1.textContent : "Article";
    __applySeo(slug, h1Text);

    const verdict = __tryExtractVerdict(contentEl);
    if(verdict){
      document.getElementById("verdictTitle").textContent = verdict.title;
      document.getElementById("verdictText").textContent = verdict.text;
      document.getElementById("verdictBox").style.display = "";
    }

    await __loadRelated(slug);
  })();
  </script>
</body>
</html>
